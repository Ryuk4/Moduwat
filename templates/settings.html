<html>
   <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
   <link rel="stylesheet" href="{{ url_for('static', filename='css/toggle.css') }}">
   <link rel="stylesheet" href="{{ url_for('static', filename='css/table.css') }}">
   <body>
      <div id="flow">
        The system has used {{ flows[0] }} L since {{ date }}
      </div>
      {% if message %}
        <p>{{ message }}</p>
      {% endif %}
      <form action= "" method= "post">
         <p>Enter adress to change</p>
         <p><input type= "text" name= "faddress" /></p>
	 <p>Enter new address</p>
	 <p><input type= "text" name=  "naddress" /></p>
         <p><input type= "submit" name= "ad_change" value= "change adress" /></p>
      </form>
      <form action= "" method= "post">
         <p><input type=  "submit" name= "scan" value= "scan" /></p>
      </form>
      
      <form action= "" id= "devices" method= "post">

      </form> 
      <form action="" method= "post">
	<p><input type= "submit" name= {{ mode }} value= {{ mode }} /></p>
      </form>
	
	<a href="graph">Humidity plots</a>
   </body>
</html>



<script>
	var devices = {{ devices }} ;
	var preselected = {{ preselected_plant }} 
	var threshold = {{ threshold }} ;
	var flows = {{ flows }} ;
	var entry_row = [];
	group = document.createElement("table");
	row_1 = document.createElement("tr");
	column_1 = document.createElement("th");
	column_1.innerHTML = "Devices";
	column_2 = document.createElement("th");
	column_2.innerHTML = "Current threshold";
	column_3 = document.createElement("th");
    column_3.innerHTML = "New threshold";
	column_4 = document.createElement("th");
	column_4.innerHTML = "Flow";
    column_5 = document.createElement("th");
    column_5.innerHTML = "Plant profile";
    row_1.appendChild(column_1);
    row_1.appendChild(column_2);
    row_1.appendChild(column_3);
	row_1.appendChild(column_4);
	row_1.appendChild(column_5);
    group.appendChild(row_1);
	document.getElementById("devices").appendChild(group);

    for (let i = 0; i < devices.length; i++) {
		entry_row[i] = document.createElement("tr");
		column_11 = document.createElement("td");
		column_11.innerHTML = "Device ".concat(devices[i]);
		column_21 = document.createElement("td");
        column_21.innerHTML = threshold[i];
		column_31 = document.createElement("td");
		input31 = document.createElement("input");
		input31.type = "text";
		input31.name = "threshold".concat(devices[i]);
		column_41 = document.createElement("td");
		column_41.innerHTML = flows[i+1];
		column_31.appendChild(input31);
		column_51 = document.createElement("td");
		entry_row[i].appendChild(column_11);
		entry_row[i].appendChild(column_21);
		entry_row[i].appendChild(column_31);
		entry_row[i].appendChild(column_41);
		entry_row[i].appendChild(column_51);
		group.appendChild(entry_row[i]);
		var id_plant = "device"+devices[i];
		var id_select = "select"+devices[i];
		form_plant = document.createElement("form");
		form_plant.name = id_plant;
		form_plant.id = id_plant;
		
		
		form_plant.method = "post";
		column_51.appendChild(form_plant);
		form_plant.innerHTML = `
    		<select id=` + id_select + ` name= ` + id_select + ` onchange="document.getElementById('` + id_plant + `').submit();" selected=` + preselected[i] + `>
        		{% for plant in data %} 
                    <option value='{{ plant }}'>
                        {{ plant }} 
                    </option> 
                {% endfor %}
            </select>
        `;
        document.getElementById(id_select).selectedIndex = preselected[i]
        
        
        //column_51.innerHTML =`
        //    <form name='plant' id ='plant' method='post'>
        //        <select name='plant_select' id='selection' onchange='submitform();'> 
        //            {% for plant in data %} 
        //                <option value='{{ plant }}'>
        //                    {{ plant }} 
        //                </option> 
        //            {% endfor %} 
        //        </select> 
        //    </form>`;
        //document.getElementById("selection").selectedIndex = {{ preselected_plant }} 
	}
	document.getElementById("devices").appendChild(group);
	//button = document.createElement("input");
	//button.type = "submit" ;
	//button.value = "change threshold" ;
	//button.name =  "change" ;
	//document.getElementById("devices").appendChild(button);
</script>


<script type="text/javascript">
//function submitform()
//{
//  document.plant.submit();
//}
</script>


<script>
// Only run what comes next *after* the page has loaded
addEventListener("DOMContentLoaded", function() {
// Grab all of the elements with a class of command
// (which all of the buttons we just created have)
        var commandButtons = document.querySelectorAll(".command");
        //alert(commandButtons.length);
        for (var i=0, l=commandButtons.length; i<l; i++) {
                var button = commandButtons[i];
                //alert(commandButtons[i]);
                // For each button, listen for the "click" event
                button.addEventListener("change", function(e) {
                        // When a click happens, stop the button
                        // from submitting our form (if we have one)
                        e.preventDefault();
                        var changedButton = e.target;
                        var command = changedButton.value;
                        // Now we need to send the data to our server
                        // without reloading the page - this is the domain of
                        // AJAX (Asynchronous JavaScript And XML)
                        // We will create a new request object
                        // and set up a handler for the response
                        var request = new XMLHttpRequest();
                        request.onload = function() {
                                // We could do more interesting things with the response
                                // or, we could ignore it entirely
                                alert(request.responseText);
                        };
                        if(this.checked){
                                request.open("GET","/"+command, true);
                                //alert("/"+command);
                                for (var i=0, l=commandButtons.length; i<l; i++) {
                                        commandButtons[i].checked = false;
                                        this.checked = true;
                                }
                        }
                        else{
                                request.open("GET","/"+command+"_OFF", true);
                        }
                        // We point the request at the appropriate command
                        //request.open("GET", "/" + command, true);
                        // and then we send it off
                        request.send();

                });
        }
}, true);
</script>

